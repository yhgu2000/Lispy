# 语法和语义

1. 字符集

   以字节为单位取流，只接受 ASCII 码中的可显示字符（即从 33 到 126 的 94 个字符）。

2. 注释

   有两种：

   - 行注释：井号“`#`”后到行尾为注释；

   - 段注释：井号“`#`”后解析一个字节串（见下文）

     ```
     # 这是一条行注释
     #"这是一个段注释"
     #'tag"
     在结束标签前加井号可以方便地注释和反注释代码
     #"tag'
     ```

3. `表达式 -> 符号引用 | 求值 | 向量构造 | 映射构造 | 立即数`

   每个表达式在编译时被转换为一个程序对象。程序对象继承自函数，接受一个上下文对象作为参数，返回求值结果。

4. `符号引用 -> <符号>`

   符号为除去空白符和特殊标点的字符串。编译为符号程序对象，符号程序对象包含一个属性，为字节串对象。

5. `求值 -> "(" 表达式* ")"`

   编译为调用程序对象，其内部包含一个向量类型属性。它会这样解释这个向量：

   - 如果向量为空，返回Null对象。
   - 求值第一个元素，如果结果是宏，则将此向量传给这个宏，返回宏在当前上下文的求值结果。
   - 否则抛出异常。

   > 对上文中“求值”这一概念的说明：
   >
   > ```c++
   > Object* evaluate(HashMap* ctx, Object* obj) {
   >     auto prg = dynamic_cast<Program*>(obj);
   >     return prg == nullptr ? obj : prg->exec(ctx);
   > }
   > ```

6. `映射构造 -> "{" ( "(" 表达式 表达式 ")" )* }"`

   编译为映射构造程序对象，内部包含两个等长的向量，一个是键程序，一个是值程序，返回值为该程序对象在上下文中依次对每个表达式进行求值，创建映射，然后将其返回。

7. `向量构造 -> "[" 表达式* "]"`

   编译为“向量构造”程序对象，其内部包含一个向量类型属性，返回值为对每个表达式进行求值，然后返回构造出的向量。

8. `立即数 -> 字节串 | 数值`

   立即数被翻译为“立即数创建”程序对象，这种程序对象在任意上下文下的求值结果都是立即数本身。

9. `字节串 -> <双引号转义字节串> | <单引号上下文有关字节串>`

   - 双引号转义字节串

     - `\` 为转义字符
     - `\\` 转义为 `\`
     - `\"` 转义为 `"`
     - `\x??` ?为十六进制数位，转义为对应的字节

   - 单引号上下文有关字节串

     ```
     '"里面允许放任何东西"'
     'tag"
     带标签形式
     "tag'
     ```

   编译为字节串对象。

10. `数值 -> [+-]? [1-9] [0-9]* ("." [0-9]+)`

    编译为数值对象，内部为64位浮点数（`double`）。


# 解释方式

1. 上下文就是映射对象
1. 上下文查找方式：先在映射中找，如果没找到，再在其自身指向的对象中找`obj[obj]`。

